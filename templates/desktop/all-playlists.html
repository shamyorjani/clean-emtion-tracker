<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  .playlist-header {
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    padding-top: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(10px);
    /* background-color: rgba(22, 212, 123, 0.3); */
    position: fixed;
    top: 0;
    bottom: 0;
    left: 0;
    z-index: 99999999999;
    display: none;
    border-radius: 8px;
  }
  .all-playlist-container {
    width: 80%;
    margin: 0 auto;
    padding: 20px;
    background-color: #1f1f1f;
    position: relative;
    color: white;
  }
  .playlist-upper h1 {
    padding: 5px 0;
    margin: 10px 0;
    box-shadow: 0 4px 1px -3.5px gray;
  }
  .playlist-control {
    display: flex;
    justify-content: end;
    padding: 5px 0;
    margin: 10px 0;
    box-shadow: 0 4px 1px -3.5px gray;
  }
  .create-btn {
    padding: 10px 20px;
    background-color: #da1111;
    color: #fff;
    text-decoration: none;
    border-radius: 5px;
    cursor: pointer;
  }
  .inner-playlist-container {
    display: flex;
    flex-wrap: wrap;
    /* justify-content: space-between; */
    align-items: center;
    gap: 20px;
  }
  .playlist {
    display: column;
    min-width: 200px;
    max-width: 300px;
    flex: 1;
    background: #000;
    gap: 10px;
    color: white;
    padding: 10px;
    border-radius: 8px;
  }
  .playlist-image {
    width: 100%;
    object-fit: cover;
    border-radius: 8px;
  }
  .playlist-inner-bottom {
    display: flex;
    justify-content: space-between;
    align-items: start;
    padding-top: 10px;
    flex: 1;
  }
  .playlist-info {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    flex: 2;
    /* gap: 30px; */
  }
  .playlist-edit-btn {
    display: flex;
    align-items: center;
    justify-content: end;
    gap: 10px;
    flex: 1;
  }
  .playlist-edit-btn img {
    width: 30%;
    cursor: pointer ;
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 999999999999999;
    left: 0;
    top: 0;
    width: 100%;
    min-height: 100vh;
    padding: 0 10px;
    overflow: none;
    /* display: flex; */
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(10px);
  }
  .modal-content {
    max-width: 600px;
    background-color: white;
    padding: 10px 50px;
    border-radius: 8px;
    position: relative;
    z-index: 9999999999999999;
  }
  form {
    padding-top: 10px;
    font-family: "Courier New", Courier, monospace;
  }
  #title,
  #description {
    border: none;
    outline: none;
    box-shadow: 0px 0px 4px silver;
    padding: 10px 10px;
    margin: 10px 0;
    border-radius: 8px;
  }
  .close {
    position: absolute;
    right: 10px;
    top: 0px;
    color: #aaa;
    font-size: 38px;
    font-weight: bold;
    cursor: pointer;
  }
  .submit-btn {
    padding: 10px 15px;
    color: white;
    font-weight: bolder;
    background-color: #da1111;
    border: none;
    border-radius: 8px;
  }
  .notification {
    font-family: "Gill Sans", "Gill Sans MT", Calibri, "Trebuchet MS",
      sans-serif;
    position: fixed;
    top: 10px;
    right: -100%;
    z-index: 99999;
    padding: 10px 15px;
    background-color: #da1111;
    color: white;
    font-weight: bolder;
    border-radius: 6px;
    transition: right 0.3s ease-in;
  }
  .main-playlist-close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 38px;
    cursor: pointer;
  }
  @media screen and (max-width: 768px) {
    .inner-playlist-container {
      justify-content: center;
    }
  }
</style>
<header class="playlist-header">
  <div class="all-playlist-container">
    <span class="main-playlist-close-btn">&times;</span>
    <div class="playlist-upper">
      <h1>All Playlist</h1>
      <div class="playlist-control">
        <span class="create-btn">Create</span>
      </div>
    </div>
    <div class="inner-playlist-container">
      <div class="playlist">
        <img
          src="https://via.placeholder.com/200"
          class="playlist-image"
          alt="Playlist Image"
        />
        <div class="playlist-inner-bottom">
          <div class="playlist-info">
            <div class="playlist-name">Playlist 1</div>
            <div class="playlist-songs-no">Songs: 23</div>
          </div>
          <div class="playlist-edit-btn">
            <a href="#">Edit</a>
          </div>
        </div>
      </div>
      <div class="playlist">
        <img
          src="https://via.placeholder.com/200"
          class="playlist-image"
          alt="Playlist Image"
        />
        <div class="playlist-inner-bottom">
          <div class="playlist-info">
            <div class="playlist-name">Playlist 1</div>
            <div class="playlist-songs-no">Songs: 23</div>
          </div>
          <div class="playlist-edit-btn">
            <span href="#">Edit</sp>
          </div>
        </div>
      </div>
      <div class="playlist">
        <img
          src="https://via.placeholder.com/200"
          class="playlist-image"
          alt="Playlist Image"
        />
        <div class="playlist-inner-bottom">
          <div class="playlist-info">
            <div class="playlist-name">Playlist 1</div>
            <div class="playlist-songs-no">Songs: 23</div>
          </div>
          <div class="playlist-edit-btn">
            <a href="#">Edit</a>
          </div>
        </div>
      </div>
      <div class="playlist">
        <img
          src="https://via.placeholder.com/200"
          class="playlist-image"
          alt="Playlist Image"
        />
        <div class="playlist-inner-bottom">
          <div class="playlist-info">
            <div class="playlist-name">Playlist 1</div>
            <div class="playlist-songs-no">Songs: 23</div>
          </div>
          <div class="playlist-edit-btn">
            <a href="#">Edit</a>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="createPlaylistModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Create Playlist</h2>
      <form class="create-playlist-form">
        <div class="playlist-title">
          <label for="title">Title:</label><br />
          <input type="text" id="title" name="title" required />
        </div>
        <div class="playlist-desc">
          <label for="description">Description:</label><br />
          <textarea id="description" name="description" required></textarea>
        </div>
        <button type="submit" class="submit-btn">Submit</button>
      </form>
      <form class="edit-playlist-form">
        <div class="playlist-title">
          <label for="title">Title:</label><br />
          <input type="text" id="title" name="title" required />
        </div>
        <div class="playlist-desc">
          <label for="description">Description:</label><br />
          <textarea id="description" name="description" required></textarea>
        </div>
        <button type="submit" class="submit-btn">Submit</button>
      </form>
    </div>
  </div>
  


  <span class="notification">Successfully created playlist!</span>
</header>

<script>
  const modal = document.getElementById("createPlaylistModal");
  const modalHeading = document.querySelector('.modal-content h2')
  const createBtn = document.querySelector(".create-btn");
  const closeBtn = document.querySelector(".close");
  const notification = document.querySelector(".notification");
  const playlistForm = document.querySelector('#playlistForm');
  // const mainPlaylistCloseBtn = document.querySelector(
  //   ".main-playlist-close-btn"
  // );

  const createPlaylist = (title, description, accessToken, userID) => {
    fetch(`https://api.spotify.com/v1/users/${userID}/playlists`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${accessToken}`,
      },
      body: JSON.stringify({
        name: title,
        description: description,
        public: false,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        console.log("Playlist created successfully:", data);
        
        notification.style.right = "10px";
        notification.style.right = "10px";
        setTimeout(() => {
          notification.style.right = "-100%";
        }, 3000);
        // Add your desired logic here
      })
      .catch((error) => {
        console.error("Error creating playlist:", error);
        // Handle the error here
      });
  };

  const updatePlaylist = (title, description, accessToken, playlistId) => {
    fetch(`https://api.spotify.com/v1/playlists/${playlistId}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${accessToken}`,
      },
      body: JSON.stringify({
        name: title,
        description: description,
        public: false,
      }),
    })
      .then((response) => response)
      .then((data) => {
        console.log("Playlist updated successfully:", data);
        notification.style.right = "10px";
        notification.style.right = "10px";
        setTimeout(() => {
          notification.style.right = "-100%";
        }, 3000);
        // Add your desired logic here
      })
      .catch((error) => {
        console.error("Error creating playlist:", error);
        // Handle the error here
      });
  };

  const deletePlaylist = (playlistID,accessToken) => {
    fetch(`https://api.spotify.com/v1/playlists/${playlistID}/followers`, {
      method: "DELETE",
      headers: {
        Authorization: `Bearer ${accessToken}`,
      },
    })
      .then((response) => response)
      .then((data) => {
        console.log("Playlist Deleted successfully:", data);
      })
      .catch((error) => {
        console.error("Error deleting playlist:", error);
        // Handle the error here
      });
  };

  const showPlaylists = (playlists) => {
    const playlistContainer = document.querySelector(
      ".inner-playlist-container"
    );
    // console.log('playlist length inside show playlist function',playlists);
    playlistContainer.innerHTML = "";
    playlists.forEach((playlist) => {
      const playlistDiv = document.createElement("div");
      playlistDiv.classList.add("playlist");
      
      playlistDiv.innerHTML = `
          <img onclick="showPlaylistDetails(this)" src="${
            playlist.images == null
              ? "https://via.placeholder.com/200"
              : playlist.images[0].url
          }" class="playlist-image hover:cursor-pointer" data-playlist-id="${playlist.id}" data-playlist-name="${playlist.name}" alt="Playlist Image" />
          <div class="playlist-inner-bottom">
            <div class="playlist-info">
              <div class="playlist-name">${playlist.name}</div>
              <div class="playlist-songs-no">Songs: ${
                playlist.tracks.total
              }</div>
            </div>
            <div class="playlist-edit-btn">
              <input type='file' id='upload-playlist-image-input' onchange="uploadImage(this)" data-playlist-id="${playlist.id}" style='display:none' />
              <img src='{{url_for('static',filename='assets/icons/cloud-arrow-up-solid.svg')}}' id="upload-playlist-image" onclick="uploadPlaylistImage(this)">
              <img src='{{url_for('static',filename='assets/icons/pen-to-square-regular.svg')}}' data-edit-name="${playlist.name}" data-edit-desc="${playlist.description}" data-playlist-id="${playlist.id}" class="edit-playlist" onclick="editPlaylist(this)">
              <img src='{{url_for('static',filename='assets/icons/trash-solid.svg')}}' class="delete-playlist" onclick="deletePlaylistBtnClicked(this)" id='${playlist.id}'>
            </div>
          </div>
        `;
      playlistContainer.appendChild(playlistDiv);
    });
    console.log('playlist length inside show playlist function',playlists.length);
  };

  const uploadPlaylistImage = (uploadBtn)=>{
    document.querySelector('#upload-playlist-image-input').click();
  }

  function readFileAsDataURL(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = (error) => reject(error);
    reader.readAsDataURL(file);
  });
}

function blobToBase64(blob) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result.split(",")[1]);
    reader.onerror = (error) => reject(error);
    reader.readAsDataURL(blob);
  });
}

  const uploadImage =  async (e)=>{
    console.log('upload playlist image input changed',e);
    const playlist_id = e.getAttribute('data-playlist-id');
    const file = e.files[0];
    

    if (!file || !file.type.startsWith('image/')) {
      alert('Please upload a valid image file.');
      return;
    }

    // Read the file as a Data URL
    const dataUrl = await readFileAsDataURL(file);
    
    // Create an Image object
    const img = new Image();
    img.src = dataUrl;
    img.onload = async () => {
      // Resize and convert to JPEG using Pica
      const canvas = document.createElement('canvas');
      const pica = window.pica();
      const resizedCanvas = await pica.resize(img, canvas, {
        width: 500, // Set your desired width
        height: 500, // Set your desired height
        preserveAspectRatio: true,
      });

      const jpegDataUrl = await pica.toBlob(resizedCanvas, 'image/jpeg', 0.8); // Adjust quality (0.0 to 1.0)

      // Convert the blob to base64 string
      const base64Jpeg = await blobToBase64(jpegDataUrl);

      
      await uploadCustomPlaylistImage(accessToken, playlist_id, base64Jpeg);

      // Now you can use base64Jpeg to upload the image to the server
      console.log(base64Jpeg);
      // Use the upload logic from the previous example to upload base64Jpeg to Spotify
    };

    
    const intervalId = setInterval(async () => {
        const playlists = await getConnectedUserPlaylists(accessToken);
        // console.log("playlists", playlists);
        showPlaylists(playlists);
      }, 2000);

      // Stop the interval after 2 seconds
      setTimeout(() => {
        clearInterval(intervalId);
      }, 6000);

  }

  const getPlaylistTracks = async (accessToken, playlist_id) => {
    const result = await fetch(
      `https://api.spotify.com/v1/playlists/${playlist_id}/tracks`,
      {
        method: "GET",
        headers: {
          Authorization: "Bearer " + accessToken,
        },
      }
    );

    const data = await result.json();
    return data;
  };
  
  const uploadCustomPlaylistImage = async (accessToken, playlist_id, image) => {
    const result = await fetch(
      `https://api.spotify.com/v1/playlists/${playlist_id}/images`,
      {
        method: "PUT",
        headers: {
          Authorization: "Bearer " + accessToken,
          "Content-Type": "image/jpeg",
        },
        body: image,
      }
    ); 
  
    const data = await result;
    return data;
  };

  const getPlaylistImage = async (accessToken, playlist_id) => {
    const result = await fetch(
      `https://api.spotify.com/v1/playlists/${playlist_id}/images`,
      {
        method: "GET",
        headers: {
          Authorization: "Bearer " + accessToken,
        },
      }
    );

    const data = await result.json();
    return data;
  };

  const showPlaylistDetails = async (playlistDiv) => {
    const playlistID = playlistDiv.getAttribute("data-playlist-id");
    console.log("playlistID CRUD got hit=>>>>", playlistID);
    showSIdeBarLoader();
    const playlistName = playlistDiv.getAttribute("data-playlist-name");
    // const playlistName = playlistNames[index].textContent;

    console.log("playlist name", playlistName);
    const playlistId = playlistDiv.getAttribute("data-playlist-id");
    const playlistTracks = await getPlaylistTracks(
      accessToken,
      playlistId
    );
    // console.log("playlistTracks", playlistTracks);
    const playlistImage = await getPlaylistImage(
      accessToken,
      playlistId
    );

    let playTracks = [];
    let tracksImages = [];
    playlistTracks.items.forEach((track) => {
      playTracks.push(track.track);
      tracksImages.push(track.track.album.images[0].url);
    });
    // playtracks.push(playlistTracks.items[index].track);
    // console.log("playlistTracks image content", element.innerHTML);
    console.log("playlistTracks", playTracks[0]);
    console.log("playlist image", playlistImage);
    displayAlbumTracks(
      playTracks,
      accessToken,
      tracksImages,
      playlistName
    );
    
  };



  // const deletingPlaylist = async(accessToken,playlists,getPlaylists)=>{
    
  // }
  const getConnectedUserPlaylists = async (accessToken) => {
    const result = await fetch("https://api.spotify.com/v1/me/playlists", {
      method: "GET",
      headers: {
        Authorization: "Bearer " + accessToken,
      },
    });

    const data = await result.json();
    return data.items;
  };
  


  function deletePlaylistBtnClicked(deleteBtn,playlists){
        console.log("deletePlaylistBtn clicked");
        // const playlistss = document.querySelectorAll(".playlist");
        const playlistID = deleteBtn.id;
        console.log("playlistID", playlistID);
        deletePlaylist(playlistID, accessToken);
    
        const intervalId = setInterval(async () => {
          const playlists = await getConnectedUserPlaylists(accessToken);
          console.log("playlists", playlists);
          showPlaylists(playlists);
        }, 1000);
    
        // Stop the interval after 2 seconds
        setTimeout(() => {
          clearInterval(intervalId);
        }, 2000);
        // console.log("deleted form array length", deletePlaylistBtns.length);
        
      }

  window.deletePlaylistBtnClicked = deletePlaylistBtnClicked;

  const allPlaylistIMage = document.querySelectorAll('.playlist-image');
  allPlaylistIMage.forEach((image)=>{
    image.addEventListener('click',()=>{
      console.log('playlist image clicked');
    })
  
  })





  // mainPlaylistCloseBtn.addEventListener("click", () => {
  //   playlistHeader.style.display = "none";
  // });
  
  createBtn.addEventListener("click", () => {
    modal.style.display = "flex";
    modalHeading.textContent = 'Create Playlist';
    const createForm = document.querySelector('.create-playlist-form ');
    createForm.style.display = 'block';
    const editForm = document.querySelector('.edit-playlist-form ');
    editForm.style.display = 'none';
    
  });

  closeBtn.addEventListener("click", () => {
    modal.style.display = "none";
  });
  
  window.addEventListener("click", (e) => {
    if (e.target === modal) {
      modal.style.display = "none";
    }
  });

  
</script>
